@page "/reports/loads"
@inherits PageBase

<RadzenHeading Size="HeadingSize.H4" Text="Loads Report" />

<RadzenCard>
    <RadzenRow>
        <RadzenColumn Size="3">
            <RadzenDatePicker @bind-Value="query.StartDate" Placeholder="From" />
        </RadzenColumn>
        <RadzenColumn Size="3">
            <RadzenDatePicker @bind-Value="query.EndDate" Placeholder="To" />
        </RadzenColumn>
        <RadzenColumn Size="3">
            <RadzenTextBox @bind-Value="query.Search" Placeholder="Search" />
        </RadzenColumn>
        <RadzenColumn Size="3" class="d-flex align-items-end">
            <RadzenButton Text="Filter" Click="LoadData" Icon="search" Style="margin-right: 0.5rem" />
            <RadzenButton Text="Reset" Click="Reset" Icon="restart_alt" ButtonStyle="ButtonStyle.Secondary" />
        </RadzenColumn>
    </RadzenRow>

    <RadzenDataGrid Data="items" TItem="LoadsReportItemDto" Count="totalCount" LoadData="OnLoadGrid" AllowPaging="true" PageSize="query.PageSize">
        <Columns>
            <RadzenDataGridColumn TItem="LoadsReportItemDto" Property="Number" Title="#" />
            <RadzenDataGridColumn TItem="LoadsReportItemDto" Property="Name" Title="Name" />
            <RadzenDataGridColumn TItem="LoadsReportItemDto" Property="Status" Title="Status" />
            <RadzenDataGridColumn TItem="LoadsReportItemDto" Property="CreatedAt" Title="Created" FormatString="{0:yyyy-MM-dd}" />
            <RadzenDataGridColumn TItem="LoadsReportItemDto" Property="DeliveredAt" Title="Delivered" FormatString="{0:yyyy-MM-dd}" />
            <RadzenDataGridColumn TItem="LoadsReportItemDto" Property="TruckNumber" Title="Truck" />
            <RadzenDataGridColumn TItem="LoadsReportItemDto" Property="CustomerName" Title="Customer" />
            <RadzenDataGridColumn TItem="LoadsReportItemDto" Property="DeliveryCost" Title="Revenue" />
            <RadzenDataGridColumn TItem="LoadsReportItemDto" Property="Distance" Title="Distance (km)" />
        </Columns>
    </RadzenDataGrid>

    <RadzenRow class="mt-3">
        <RadzenColumn Size="4"><b>Total Revenue:</b> @totalRevenue</RadzenColumn>
        <RadzenColumn Size="4"><b>Total Distance:</b> @totalDistance</RadzenColumn>
        <RadzenColumn Size="4"><b>Total Count:</b> @totalCount</RadzenColumn>
    </RadzenRow>
</RadzenCard>

@code {
    private LoadsReportQuery query = new() { Page = 1, PageSize = 10 };
    private IEnumerable<LoadsReportItemDto> items = Array.Empty<LoadsReportItemDto>();
    private int totalCount;
    private decimal totalRevenue;
    private double totalDistance;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task OnLoadGrid(LoadDataArgs args)
    {
        int pageSize = args.Top ?? query.PageSize;
        int skip = args.Skip ?? 0;
        if (pageSize > 0)
        {
            query.Page = (skip / pageSize) + 1;
            query.PageSize = pageSize;
        }
        await LoadData();
    }

    private async Task LoadData()
    {
        var res = await CallApiAsync(c => c.GetLoadsReportAsync(query));
        if (res != null)
        {
            items = res.Items;
            totalCount = res.TotalCount;
            totalRevenue = res.TotalRevenue;
            totalDistance = res.TotalDistance;
        }
    }

    private async Task Reset()
    {
        query = new LoadsReportQuery { Page = 1, PageSize = 10 };
        await LoadData();
    }
}

